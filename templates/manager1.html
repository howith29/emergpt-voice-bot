<!DOCTYPE html>
<html>
<head>
    <title>ì‹ ê³ í™•ì¸ í˜ì´ì§€</title>
    <style>
        body {
            font-family: 'NanumSquare', sans-serif;
            margin: 0;
            background-color: #f2f2f2;
        }

        .header {
            background: linear-gradient(135deg, #204080 0%, #202020 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            padding: 10px;
        }

        .header-title {
            font-weight: bold;
            font-size: 24px;
            text-align: center;
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            margin: 0 auto;
            overflow-x: auto;
            height: 100vh;
        }

        .filter-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-left: 10px;
        }

        .filter-label {
            margin-right: 10px;
        }

        .filter-select,
        .filter-input {
            padding: 5px;
            box-sizing: border-box;
        }

        .alert-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        .alert-table th,
        .alert-table td {
            max-width: 200px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }

        .alert-table th {
            background-color: #fdf8e1;
        }

        .alert-table-container {
            max-height: 100%;
            overflow-y: auto;
        }
        
        

        .checkbox-cell {
            text-align: center;
        }
        
        .checkbox1-cell {
            text-align: center;
        }
        

        .close-button {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .close-button:hover {
            background-color: #eee;
        }
    </style>
</head>
<body>
    <!-- í˜ì´ì§€ ìƒë‹¨ í—¤ë” ì˜ì—­ -->
    <div class="header">
        <div class="header-first"></div>
        <div class="header-title">ì‹ ê³  í˜„í™©</div>
        <button class="close-button" id="closeButton">âœ–ï¸</button>

    </div>

    <!-- ë°ì´í„° í•„í„°ë§ê³¼ í…Œì´ë¸”ì„ ë³´ì—¬ì£¼ëŠ” ì»¨í…Œì´ë„ˆ ì˜ì—­ -->
    <div class="container">
        <div class="filter-container">
            <label class="filter-label" for="filterColumn">ğŸ”</label>
            <select class="filter-select" id="filterColumn">
                <option value="all">ì „ì²´</option>
                <option value="incident">ì¬í•´ìƒí™©</option>
                <option value="location">ìœ„ì¹˜</option>
                <option value="timestamp">ë°œê²¬ì‹œê°</option> 
                <option value="progress">ì§„í–‰ìƒíƒœ</option>
                <option value="reporttime">ì‹ ê³ ì‹œê°</option>

            </select>
            <input type="text" class="filter-input" id="filterInput" placeholder="ê²€ìƒ‰...">
        </div>

        <div class="alert-table-container">
            <table class="alert-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ì¬í•´ìƒí™©</th>
                        <th>ì§„í–‰ìƒíƒœ</th>
                        <th>ìœ„ì¹˜</th>
                        <th>ì‹ ê³ ì‹œê°</th>
                        <th>ë°œê²¬ì‹œê°</th>
                        <th>í™•ì¸</th>
                        <th>í•´ê²°</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- ì—¬ê¸°ì— ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- AWS SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/aws-sdk@2.1118.0/dist/aws-sdk.min.js"></script>
    <script>
        // AWS ì„¤ì • ë° ì¸ì¦ ì •ë³´ ì„¤ì •
        AWS.config.update({
            region: 'ap-northeast-2',
            credentials: new AWS.Credentials('','')
        });

        // AWS DynamoDB DocumentClient ìƒì„±
        const dynamodb = new AWS.DynamoDB.DocumentClient();
        const tableBody = document.getElementById('tableBody');


        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function fetchData() {
            try {
                const params = {
                    TableName: 'test_2_chatbot'
                };
                const data = await dynamodb.scan(params).promise();

                data.Items.forEach((report, index) => {
                    // í…Œì´ë¸” í–‰ ìƒì„±
                    const row = document.createElement('tr');

                    // í…Œì´ë¸” ì…€ ìƒì„± ë° ë°ì´í„° ì±„ìš°ê¸°
                    const indexCell = document.createElement('td');
                    indexCell.textContent = index + 1;
                    row.appendChild(indexCell);

                    const incidentCell = document.createElement('td');
                    incidentCell.textContent = `${report.incident} - ${report.incident_status}`;
                    row.appendChild(incidentCell);

                    const progressCell = document.createElement('td');
                    progressCell.textContent = report.user_id;
                    row.appendChild(progressCell);

                    const locationCell = document.createElement('td');
                    locationCell.textContent = report.location;
                    row.appendChild(locationCell);

                    const timestampCell = document.createElement('td');
                    timestampCell.textContent = report.timestamp;
                    row.appendChild(timestampCell);

                    const reporttimeCell = document.createElement('td');
                    reporttimeCell.textContent = report.reporttime;
                    row.appendChild(reporttimeCell);
                    
                    const confirmCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'confirmCheckbox';
                    confirmCell.className = 'checkbox-cell';
                    confirmCell.appendChild(checkbox);
                    row.appendChild(confirmCell);
                    
                    const solvedCell = document.createElement('td');
                    const checkboxx = document.createElement('input');
                    checkboxx.type = 'checkbox';
                    checkboxx.name = 'solvedCheckbox';
                    solvedCell.className = 'checkbox1-cell';
                    solvedCell.appendChild(checkboxx);
                    row.appendChild(solvedCell);

                    // í…Œì´ë¸” í–‰ì„ í…Œì´ë¸” ë³¸ë¬¸ì— ì¶”ê°€
                    tableBody.appendChild(row);
                });

                let time1;
                let time2;
                let checktime;
                // ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                tableBody.addEventListener('click', async function(event) {
                    if (event.target.type === 'checkbox' && event.target.name === 'confirmCheckbox') {
                        const checkbox = event.target;
                        const row = checkbox.closest('tr');
                
                        if (row) {
                            const currentTime1 = new Date().toISOString();
                            const time1 = new Date(currentTime1).getTime();
                            checktime = time1;
                        }
                    }
                });
                tableBody.addEventListener('click', async function(event) {
                    if (event.target.type === 'checkbox' && event.target.name === 'solvedCheckbox') {
                        const checkboxx = event.target;
                        const row = checkboxx.closest('tr');
                        
                        if (row) {
                            const currentTime2 = new Date().toISOString();
                            const time2 = new Date(currentTime2).getTime();
                            const timeDifferenceInMilliseconds = Math.abs(time2 - checktime);
                            const millisecondsPerMinute = 60 * 1000;
                            const minutes = Math.floor(timeDifferenceInMilliseconds / millisecondsPerMinute);
                        
                            const cells = row.querySelectorAll('td');
                            const incidentCell = cells[2]; // ì¬í•´ìƒí™© ì—´ì˜ ì…€
                            const timestampCell = cells[4]; // íƒ€ì„ìŠ¤íƒ¬í”„ ì—´ì˜ ì…€
                
                            const incidentID = incidentCell.textContent.trim(); // ì¬í•´ìƒí™© ID ê°’
                            const timestamp = timestampCell.textContent.trim(); // íƒ€ì„ìŠ¤íƒ¬í”„ ê°’

                            const params = {
                                TableName: "test_2_chatbot",
                                Key: {
                                    user_id: incidentID, // íŒŒí‹°ì…˜ í‚¤ ê°’
                                    timestamp: timestamp // ì •ë ¬ í‚¤ ê°’
                                }
                            };
                            
                            fetch('/manager1', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ user_id: incidentID, timestamp: timestamp, minutes: minutes, start_time:time1, end_time:time2 })
                            });
                            
                            console.log("incidentIDëŠ” : " + incidentID + "timestampeëŠ” : " + timestamp);
                            dynamodb.delete(params, (error, data) => {
                                if (error) {
                                    console.error('Error deleting item from DynamoDB:', error);
                                } else {
                                    console.log('Item deleted from DynamoDB');

                                    row.remove();
                                }
                            });
                        }
                    }
                });
 
                
                
            }catch (error) {
                console.error('Error fetching data from DynamoDB:', error);
            }
        }
        
       // AWS SDKì˜ í˜„ì¬ ë¦¬ì „ ì €ì¥
        const currentRegion = AWS.config.region;
        
        // AWS ì„¤ì • ë° ì¸ì¦ ì •ë³´ ì„¤ì •
        AWS.config.update({
            region: 'ap-northeast-1', // SNSë¥¼ ë³´ë‚¼ ë¦¬ì „ìœ¼ë¡œ ì„¤ì •
            credentials: new AWS.Credentials('','') // Access Keyì™€ Secret Keyë„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        });
        
        const closeButton = document.getElementById('closeButton');
        closeButton.addEventListener('click', navigateToSelectPage);

        // Select í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function navigateToSelectPage() {
             window.location.href = '/'; 
        }

       
        function sendSNSAlert(message) {
            const sns_client = new AWS.SNS(); // SNS í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            const topicArn = "";
        
            try {
                const snsParams = {
                    TopicArn: topicArn,
                    Message: message
                };
                sns_client.publish(snsParams, (err, data) => {
                    // ì´ì „ ë¦¬ì „ìœ¼ë¡œ ë¦¬ì „ ë³µì›
                    AWS.config.update({ region: currentRegion });
        
                    if (err) {
                        console.error("ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                    } else {
                        console.log("ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } catch (e) {
                // ì´ì „ ë¦¬ì „ìœ¼ë¡œ ë¦¬ì „ ë³µì›
                AWS.config.update({ region: currentRegion });
        
                console.error("ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", e);
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ í˜¸ì¶œ
        fetchData();
        
        //ì‹ ê³ ì‹œê° ì •ë ¬
        const timestampHeader = document.querySelector('.alert-table th:nth-child(5)'); 
        let sortOrder = false;

        timestampHeader.addEventListener('click', () => {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
        
            rows.sort((a, b) => {
                const aTimestamp = new Date(a.cells[4].textContent.trim());
                const bTimestamp = new Date(b.cells[4].textContent.trim());
        
                if (sortOrder) {
                    return aTimestamp - bTimestamp;
                } else {
                    return bTimestamp - aTimestamp;
                }
            });
        
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        
            sortOrder = !sortOrder;
        });


            // ê²€ìƒ‰ í•„í„°ì™€ ê²€ìƒ‰ì–´ ì…ë ¥ í•„ë“œ
        const filterColumnSelect = document.getElementById('filterColumn');
        const filterInput = document.getElementById('filterInput');
        
        // ê²€ìƒ‰ í•„í„° ë° ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸” í•„í„°ë§
        function applySearchFilter() {
            const searchTerm = filterInput.value.toLowerCase();
        
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let shouldShowRow = false;
        

                cells.forEach(cell => {
                    const cellText = cell.textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            shouldShowRow = true;
                    }
                });
        
                row.style.display = shouldShowRow ? 'table-row' : 'none';
            });
        }
        
        // ê²€ìƒ‰ í•„í„° ë° ê²€ìƒ‰ì–´ ì…ë ¥ í•„ë“œì˜ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
        filterColumnSelect.addEventListener('change', applySearchFilter);
        filterInput.addEventListener('input', applySearchFilter);
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ê²€ìƒ‰ í•„í„° ì ìš©
        async function fetchDataAndApplyFilter() {
            // ê²€ìƒ‰ í•„í„° ì ìš©
            applySearchFilter();
        }
        
        // ê²€ìƒ‰ í•„í„° ì ìš© ì´ˆê¸°í™”
        fetchDataAndApplyFilter();

    </script>
</body>
</html>